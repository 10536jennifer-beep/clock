<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專注讀書計時器</title>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 設定 Tailwind Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937', // Custom dark gray for cards
                            900: '#111827', // Dark background
                            950: '#030712', // Deep dark
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 自訂動畫樣式 -->
    <style>
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slide-in-from-bottom {
            from { transform: translateY(0.5rem); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slide-in-from-right {
            from { transform: translateX(1rem); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes zoom-in {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-in { animation-fill-mode: forwards; }
        .fade-in { animation-name: fade-in; }
        .slide-in-from-bottom-2 { animation-name: slide-in-from-bottom; }
        .slide-in-from-right { animation-name: slide-in-from-right; }
        .zoom-in { animation-name: zoom-in; }
        
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Custom Scrollbar for Dark Mode */
        .dark ::-webkit-scrollbar {
            width: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icon Components ---
        const IconBase = ({ size = 24, style, children, className }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                style={style}
                className={className}
            >
                {children}
            </svg>
        );

        const Calendar = (props) => (
            <IconBase {...props}>
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </IconBase>
        );
        const X = (props) => (
            <IconBase {...props}>
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </IconBase>
        );
        const Clock = (props) => (
            <IconBase {...props}>
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </IconBase>
        );
        const ChevronLeft = (props) => (
            <IconBase {...props}>
                <polyline points="15 18 9 12 15 6"></polyline>
            </IconBase>
        );
        const ChevronRight = (props) => (
            <IconBase {...props}>
                <polyline points="9 18 15 12 9 6"></polyline>
            </IconBase>
        );
        const Play = (props) => (
            <IconBase {...props}>
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </IconBase>
        );
        const Pause = (props) => (
            <IconBase {...props}>
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </IconBase>
        );
        const Square = (props) => (
            <IconBase {...props}>
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </IconBase>
        );
        const History = (props) => (
            <IconBase {...props}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
                <path d="M12 7v5l4 2"></path>
            </IconBase>
        );
        const Trash2 = (props) => (
            <IconBase {...props}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </IconBase>
        );
        const Palette = (props) => (
            <IconBase {...props}>
                <circle cx="13.5" cy="6.5" r=".5"></circle>
                <circle cx="17.5" cy="10.5" r=".5"></circle>
                <circle cx="8.5" cy="7.5" r=".5"></circle>
                <circle cx="6.5" cy="12.5" r=".5"></circle>
                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path>
            </IconBase>
        );
        const Moon = (props) => (
            <IconBase {...props}>
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </IconBase>
        );
        const Sun = (props) => (
            <IconBase {...props}>
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </IconBase>
        );

        // --- 色彩輔助函式 ---
        const hexToRgb = (hex) => {
            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        };

        const rgbToHex = (r, g, b) => {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        };

        const mixColors = (color1, color2, weight) => {
            const c1 = hexToRgb(color1);
            const c2 = hexToRgb(color2);
            const r = Math.round(c1.r * weight + c2.r * (1 - weight));
            const g = Math.round(c1.g * weight + c2.g * (1 - weight));
            const b = Math.round(c1.b * weight + c2.b * (1 - weight));
            return rgbToHex(r, g, b);
        };

        const generatePalette = (baseColor) => {
            return {
                50: mixColors('#ffffff', baseColor, 0.95),
                100: mixColors('#ffffff', baseColor, 0.9),
                200: mixColors('#ffffff', baseColor, 0.75),
                300: mixColors('#ffffff', baseColor, 0.6),
                400: mixColors('#ffffff', baseColor, 0.3),
                500: baseColor,
                600: mixColors('#000000', baseColor, 0.1),
                700: mixColors('#000000', baseColor, 0.3),
                800: mixColors('#000000', baseColor, 0.5),
                900: mixColors('#000000', baseColor, 0.7),
            };
        };

        const PRESET_COLORS = [
            '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', 
            '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', 
            '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', 
            '#ec4899', '#f43f5e', '#78716c', '#737373', '#71717a', 
            '#64748b', '#475569', '#334155', '#1e293b', '#0f172a', 
        ];

        const formatTime = (totalSeconds) => {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => num.toString().padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        };

        const formatDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const getDaysInMonth = (year, month) => {
            const date = new Date(year, month, 1);
            const days = [];
            while (date.getMonth() === month) {
                days.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            return days;
        };

        // --- Modal 組件 ---
        const Modal = ({ title, isOpen, onClose, onConfirm, children, confirmText = "確定", isDanger = false, themeStyles }) => {
            if (!isOpen) return null;
            
            const btnStyle = isDanger 
                ? { backgroundColor: '#ef4444', color: 'white' }
                : { backgroundColor: 'var(--theme-600)', color: 'white' };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-100">{title}</h3>
                            </div>
                            <div className="mb-6 text-gray-700 dark:text-gray-300">
                                {children}
                            </div>
                            <div className="flex justify-end gap-3">
                                <button 
                                    onClick={onClose}
                                    className="px-4 py-2 text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 rounded-lg transition-colors font-medium"
                                >
                                    取消
                                </button>
                                <button 
                                    onClick={onConfirm}
                                    style={btnStyle}
                                    className={`px-4 py-2 rounded-lg transition-opacity hover:opacity-90 shadow-md font-bold`}
                                >
                                    {confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [view, setView] = useState('timer');
            const [selectedDate, setSelectedDate] = useState(null);
            const [seconds, setSeconds] = useState(0);
            const [isActive, setIsActive] = useState(false);
            const [sessionName, setSessionName] = useState('');
            const [startTime, setStartTime] = useState(null);
            const [showStartModal, setShowStartModal] = useState(false);
            const [showEndModal, setShowEndModal] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [recordToDelete, setRecordToDelete] = useState(null);
            const [showColorModal, setShowColorModal] = useState(false);

            // 主題色狀態
            const [themeColor, setThemeColor] = useState(() => localStorage.getItem('themeColor') || '#22c55e');
            
            // 深色模式狀態
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('isDarkMode');
                return saved ? JSON.parse(saved) : false;
            });

            const startInputRef = useRef(null);
            const endNoteRef = useRef(null);
            const timerRef = useRef(null);
            const startTimeRef = useRef(0); // 新增：用於記錄基準開始時間
            
            const [history, setHistory] = useState(() => {
                try {
                    const saved = localStorage.getItem('studyHistory');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            const [calendarYear, setCalendarYear] = useState(new Date().getFullYear());
            const [calendarMonth, setCalendarMonth] = useState(new Date().getMonth());

            const palette = useMemo(() => generatePalette(themeColor), [themeColor]);

            // CSS 變數
            const containerStyle = {
                '--theme-50': palette[50],
                '--theme-100': palette[100],
                '--theme-200': palette[200],
                '--theme-300': palette[300],
                '--theme-500': palette[500],
                '--theme-600': palette[600],
                '--theme-700': palette[700],
                '--theme-800': palette[800],
                '--theme-900': palette[900],
            };

            const getIntensityStyle = (seconds) => {
                const hours = seconds / 3600;
                // 深色模式下的顏色邏輯需要稍微調整，這裡保持 CSS 變數，利用透明度或特定深色色階
                if (hours === 0) return { 
                    backgroundColor: isDarkMode ? '#374151' : '#f3f4f6', // gray-700 : gray-100
                    color: isDarkMode ? '#9ca3af' : '#9ca3af' 
                };
                if (hours < 2) return { backgroundColor: 'var(--theme-100)', color: 'var(--theme-800)' };
                if (hours < 5) return { backgroundColor: 'var(--theme-300)', color: 'var(--theme-900)' };
                if (hours < 8) return { backgroundColor: 'var(--theme-500)', color: '#ffffff' };
                if (hours < 10) return { backgroundColor: 'var(--theme-700)', color: '#ffffff' };
                return { backgroundColor: 'var(--theme-900)', color: '#ffffff' };
            };

            useEffect(() => {
                if (isActive) {
                    // 修正計時邏輯：使用 Date.now() 差值計算，解決螢幕關閉時瀏覽器降速問題
                    // 設定一個「理論上的開始時間」，即「現在 - 已過秒數」
                    startTimeRef.current = Date.now() - (seconds * 1000);
                    
                    timerRef.current = setInterval(() => {
                        const now = Date.now();
                        // 每次都重新計算「現在」與「理論開始時間」的差距
                        const elapsed = Math.floor((now - startTimeRef.current) / 1000);
                        setSeconds(elapsed);
                    }, 1000);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isActive]);

            useEffect(() => {
                localStorage.setItem('studyHistory', JSON.stringify(history));
            }, [history]);

            useEffect(() => {
                localStorage.setItem('themeColor', themeColor);
            }, [themeColor]);

            // Apply Dark Mode Class
            useEffect(() => {
                localStorage.setItem('isDarkMode', JSON.stringify(isDarkMode));
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);

            // Handlers
            const handleStartClick = () => {
                if (isActive) return;
                if (seconds > 0) setIsActive(true);
                else setShowStartModal(true);
            };

            const confirmStart = () => {
                const name = startInputRef.current?.value || '';
                if (!name.trim()) return;
                setSessionName(name);
                setStartTime(new Date().toISOString());
                setSeconds(0);
                setIsActive(true);
                setShowStartModal(false);
            };

            const confirmEnd = () => {
                const notes = endNoteRef.current?.value || '';
                const newRecord = {
                    id: Date.now(),
                    date: formatDateKey(startTime),
                    name: sessionName,
                    notes: notes,
                    duration: seconds,
                    startTime: startTime,
                    endTime: new Date().toISOString(),
                };
                setHistory([newRecord, ...history]);
                setSeconds(0);
                setSessionName('');
                setStartTime(null);
                setShowEndModal(false);
            };

            const initiateDelete = (id) => {
                setRecordToDelete(id);
                setShowDeleteModal(true);
            };

            const confirmDelete = () => {
                if (recordToDelete) {
                    setHistory(prev => prev.filter(r => r.id !== recordToDelete));
                    setRecordToDelete(null);
                    setShowDeleteModal(false);
                }
            };

            const getDailyTotalSeconds = (dateStr) => history.filter(r => r.date === dateStr).reduce((acc, curr) => acc + curr.duration, 0);
            const getDayRecords = (dateStr) => history.filter(r => r.date === dateStr).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            const prevMonth = () => {
                if (calendarMonth === 0) { setCalendarMonth(11); setCalendarYear(calendarYear - 1); }
                else setCalendarMonth(calendarMonth - 1);
            };
            const nextMonth = () => {
                if (calendarMonth === 11) { setCalendarMonth(0); setCalendarYear(calendarYear + 1); }
                else setCalendarMonth(calendarMonth + 1);
            };

            return (
                <div 
                    className="min-h-screen bg-gray-50 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-100 flex flex-col items-center relative overflow-hidden transition-colors duration-500"
                    style={containerStyle}
                >
                
                {/* 頂部導航列 */}
                <nav className="w-full max-w-md p-4 flex justify-between items-center relative z-10 bg-gray-50/90 dark:bg-gray-900/90 backdrop-blur-sm transition-colors duration-500">
                    <div className="flex items-center gap-2">
                        {view !== 'timer' && (
                            <button 
                                onClick={() => setView(view === 'dayDetail' ? 'calendar' : 'timer')}
                                className="p-2 rounded-full bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 shadow-sm hover:shadow-md transition-all"
                            >
                                <ChevronLeft size={20} />
                            </button>
                        )}
                        <h1 className="text-lg font-bold text-gray-700 dark:text-gray-100">
                            {view === 'timer' ? '專注計時' : view === 'calendar' ? '學習月曆' : selectedDate}
                        </h1>
                    </div>

                    <div className="flex gap-2">
                         {/* 深色模式切換按鈕 */}
                        <button 
                            onClick={() => setIsDarkMode(!isDarkMode)}
                            className="p-3 bg-white dark:bg-gray-800 rounded-xl shadow-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-md transition-all"
                            title={isDarkMode ? "切換至亮色模式" : "切換至深色模式"}
                        >
                            {isDarkMode ? <Sun size={24} /> : <Moon size={24} />}
                        </button>

                        {view === 'timer' && (
                            <>
                                <button 
                                    onClick={() => setShowColorModal(true)}
                                    className="p-3 bg-white dark:bg-gray-800 rounded-xl shadow-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-md transition-all group"
                                >
                                    <div className="relative">
                                        <Palette size={24} style={{ color: 'var(--theme-600)' }} />
                                    </div>
                                </button>
                                <button 
                                    onClick={() => setView('calendar')}
                                    className="p-3 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-md transition-all"
                                >
                                    <Calendar size={24} style={{ color: 'var(--theme-600)' }} />
                                </button>
                            </>
                        )}
                    </div>
                </nav>

                {/* 主要內容區 */}
                <main className="flex-1 w-full max-w-md p-4 flex flex-col relative z-0">
                    
                    {/* --- 計時器介面 --- */}
                    {view === 'timer' && (
                        <div className="flex flex-col items-center flex-1 w-full">
                            <div className="flex-1 min-h-[1rem]"></div>

                            <div className="flex flex-col items-center space-y-6">
                                <div className="text-center h-8">
                                    {sessionName ? (
                                        <div 
                                            className="inline-flex items-center gap-2 px-4 py-1 rounded-full text-sm font-medium animate-in fade-in slide-in-from-bottom-2"
                                            style={{ backgroundColor: 'var(--theme-100)', color: 'var(--theme-800)' }}
                                        >
                                            <Clock size={14} />
                                            正在研讀: {sessionName}
                                        </div>
                                    ) : (
                                        <span className="text-gray-400 dark:text-gray-500 text-sm">準備開始新的專注</span>
                                    )}
                                </div>

                                <div className="relative py-4">
                                    <div 
                                        className="text-7xl font-mono font-light tracking-tight text-gray-900 dark:text-gray-50 tabular-nums drop-shadow-sm transition-colors"
                                        style={{ fontVariantNumeric: 'tabular-nums' }}
                                    >
                                        {formatTime(seconds)}
                                    </div>
                                    <div 
                                        className={`absolute inset-0 rounded-full border-2 -z-10 transition-all duration-1000 ${isActive ? 'scale-125 opacity-100 animate-pulse' : 'scale-100 opacity-0'}`}
                                        style={{ borderColor: 'var(--theme-200)', top: '-20px', bottom: '-20px' }}
                                    ></div>
                                </div>
                            </div>

                            <div className="flex-1 min-h-[1rem]"></div>

                            <div className="flex items-center gap-6 mb-20 z-10">
                                <button 
                                    onClick={() => setIsActive(false)}
                                    disabled={!isActive}
                                    className={`flex flex-col items-center gap-2 group transition-all duration-300 ${!isActive ? 'opacity-50 grayscale' : ''}`}
                                >
                                    <div className="w-16 h-16 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-500 flex items-center justify-center shadow-lg group-active:scale-95 transition-transform border-4 border-white dark:border-gray-800 ring-2 ring-yellow-50 dark:ring-yellow-900/20">
                                        <Pause size={28} fill="currentColor" />
                                    </div>
                                    <span className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">暫停</span>
                                </button>

                                <button 
                                    onClick={handleStartClick}
                                    className="flex flex-col items-center gap-2 group relative z-10"
                                >
                                    <div 
                                        className={`w-24 h-24 rounded-full flex items-center justify-center shadow-xl transition-all duration-300 border-8 border-white dark:border-gray-800 ring-4 group-active:scale-95`}
                                        style={isActive 
                                            ? { backgroundColor: 'var(--theme-100)', color: 'var(--theme-600)', boxShadow: '0 0 0 4px var(--theme-100)' }
                                            : { backgroundColor: 'var(--theme-600)', color: 'white', boxShadow: '0 0 0 4px var(--theme-200)' }
                                        }
                                    >
                                        {isActive ? (
                                            <Clock size={40} className="animate-spin-slow" />
                                        ) : (
                                            <Play size={40} fill="currentColor" className="ml-1" />
                                        )}
                                    </div>
                                    <span className="text-sm font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider mt-1">
                                        {isActive ? '計時中...' : seconds > 0 ? '繼續' : '開始'}
                                    </span>
                                </button>

                                <button 
                                    onClick={() => { setIsActive(false); setShowEndModal(true); }}
                                    disabled={seconds === 0}
                                    className={`flex flex-col items-center gap-2 group transition-all duration-300 ${seconds === 0 ? 'opacity-30 cursor-not-allowed' : ''}`}
                                >
                                    <div className="w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-500 flex items-center justify-center shadow-lg group-active:scale-95 transition-transform border-4 border-white dark:border-gray-800 ring-2 ring-red-50 dark:ring-red-900/20">
                                        <Square size={24} fill="currentColor" />
                                    </div>
                                    <span className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">結束</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {/* --- 日曆介面 --- */}
                    {view === 'calendar' && (
                        <div className="flex flex-col space-y-6 animate-in slide-in-from-right duration-300">
                            <div className="flex items-center justify-between px-2">
                                <button onClick={prevMonth} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full"><ChevronLeft /></button>
                                <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100">{calendarYear} 年 {calendarMonth + 1} 月</h2>
                                <button onClick={nextMonth} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full"><ChevronRight /></button>
                            </div>

                            <div className="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 transition-colors">
                                <div className="grid grid-cols-7 gap-2 mb-2">
                                    {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                                        <div key={d} className="text-center text-xs text-gray-400 font-medium py-1">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {Array.from({ length: new Date(calendarYear, calendarMonth, 1).getDay() }).map((_, i) => (
                                        <div key={`empty-${i}`} className="aspect-square"></div>
                                    ))}
                                    
                                    {getDaysInMonth(calendarYear, calendarMonth).map(date => {
                                        const dateStr = formatDateKey(date);
                                        const isToday = dateStr === formatDateKey(new Date());
                                        const intensityStyle = getIntensityStyle(getDailyTotalSeconds(dateStr));

                                        return (
                                            <button
                                                key={dateStr}
                                                onClick={() => { setSelectedDate(dateStr); setView('dayDetail'); }}
                                                className={`aspect-square rounded-lg flex flex-col items-center justify-center text-xs transition-transform hover:scale-105 relative ${isToday ? 'ring-2 ring-offset-2 font-bold' : ''}`}
                                                style={{ 
                                                    ...intensityStyle,
                                                    borderColor: isToday ? 'var(--theme-500)' : 'transparent',
                                                    outlineColor: isToday ? 'var(--theme-500)' : 'transparent'
                                                }}
                                            >
                                                <span>{date.getDate()}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="flex items-center justify-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                                <span>少</span>
                                <div className="w-3 h-3 rounded" style={{ backgroundColor: 'var(--theme-100)' }}></div>
                                <div className="w-3 h-3 rounded" style={{ backgroundColor: 'var(--theme-300)' }}></div>
                                <div className="w-3 h-3 rounded" style={{ backgroundColor: 'var(--theme-500)' }}></div>
                                <div className="w-3 h-3 rounded" style={{ backgroundColor: 'var(--theme-700)' }}></div>
                                <div className="w-3 h-3 rounded" style={{ backgroundColor: 'var(--theme-900)' }}></div>
                                <span>多 (10hr+)</span>
                            </div>

                            <div 
                                className="p-4 rounded-xl flex justify-around items-center bg-gray-50 dark:bg-gray-700/50"
                                style={!isDarkMode ? { backgroundColor: 'var(--theme-50)', color: 'var(--theme-900)' } : { color: 'var(--theme-100)' }}
                            >
                                <div className="text-center">
                                    <div className="text-2xl font-bold">
                                        {getDaysInMonth(calendarYear, calendarMonth).reduce((acc, date) => getDailyTotalSeconds(formatDateKey(date)) > 0 ? acc + 1 : acc, 0)}
                                    </div>
                                    <div className="text-xs opacity-70">學習天數</div>
                                </div>
                                <div className="h-8 w-px" style={{ backgroundColor: 'var(--theme-200)' }}></div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold">
                                        {Math.floor(getDaysInMonth(calendarYear, calendarMonth).reduce((acc, date) => acc + getDailyTotalSeconds(formatDateKey(date)), 0) / 3600)}
                                    </div>
                                    <div className="text-xs opacity-70">總時數 (hr)</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- 單日時間軸詳細介面 --- */}
                    {view === 'dayDetail' && selectedDate && (
                        <div className="flex flex-col h-full animate-in slide-in-from-right duration-300">
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex-1 overflow-y-auto p-4 transition-colors">
                                <div className="flex items-center gap-2 mb-6">
                                    <div 
                                        className="p-2 rounded-lg"
                                        style={getIntensityStyle(getDailyTotalSeconds(selectedDate))}
                                    >
                                        <History size={20} />
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-lg text-gray-800 dark:text-gray-100">學習時間軸</h3>
                                        <p className="text-xs text-gray-500 dark:text-gray-400">總計: {formatTime(getDailyTotalSeconds(selectedDate))}</p>
                                    </div>
                                </div>

                                <div className="relative pl-4 border-l-2 border-gray-100 dark:border-gray-700 space-y-8">
                                    {getDayRecords(selectedDate).length === 0 ? (
                                        <div className="text-center py-10 text-gray-400 dark:text-gray-500">當天沒有讀書紀錄，好好休息了嗎？</div>
                                    ) : (
                                        getDayRecords(selectedDate).map((record) => (
                                            <div key={record.id} className="relative group">
                                                <div className="absolute -left-[21px] top-0 w-3 h-3 rounded-full ring-4 ring-white dark:ring-gray-800 transition-colors" style={{ backgroundColor: 'var(--theme-500)' }}></div>
                                                
                                                <div className="flex flex-col gap-1">
                                                    <div className="flex justify-between items-start">
                                                        <span className="text-xs font-mono text-gray-400 dark:text-gray-500">
                                                            {new Date(record.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - 
                                                            {new Date(record.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                        </span>
                                                        <button 
                                                            onClick={() => initiateDelete(record.id)}
                                                            className="p-1 text-gray-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 dark:hover:text-red-400 rounded transition-colors"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    </div>

                                                    <h4 className="font-bold text-gray-800 dark:text-gray-200 text-lg">{record.name}</h4>
                                                    <div 
                                                        className="inline-block self-start px-2 py-0.5 text-xs rounded mb-2"
                                                        style={!isDarkMode ? { backgroundColor: 'var(--theme-50)', color: 'var(--theme-700)' } : { backgroundColor: 'rgba(255,255,255,0.1)', color: 'var(--theme-200)' }}
                                                    >
                                                        專注時長: {formatTime(record.duration)}
                                                    </div>
                                                    {record.notes && (
                                                        <div 
                                                            className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg text-sm text-gray-600 dark:text-gray-300 italic border-l-4 whitespace-pre-wrap transition-colors"
                                                            style={{ borderColor: 'var(--theme-200)' }}
                                                        >
                                                            {record.notes}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </main>

                {/* Start Modal */}
                <Modal 
                    title="開始新的學習" 
                    isOpen={showStartModal} 
                    onClose={() => setShowStartModal(false)}
                    onConfirm={confirmStart}
                    confirmText="開始計時"
                >
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">這次要讀什麼科目/主題？</label>
                    <input 
                        ref={startInputRef}
                        autoFocus
                        type="text" 
                        placeholder="例如：數學、英文單字..."
                        className="w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none transition-all placeholder-gray-400 dark:placeholder-gray-500"
                        style={{ '--tw-ring-color': 'var(--theme-500)' }}
                        onFocus={(e) => { e.target.style.borderColor = 'var(--theme-500)'; e.target.style.boxShadow = '0 0 0 2px var(--theme-500)'; }}
                        onBlur={(e) => { e.target.style.borderColor = ''; e.target.style.boxShadow = 'none'; }}
                        onKeyDown={(e) => e.key === 'Enter' && confirmStart()}
                    />
                </Modal>

                {/* End Modal */}
                <Modal 
                    title="完成學習" 
                    isOpen={showEndModal} 
                    onClose={() => setShowEndModal(false)}
                    onConfirm={confirmEnd}
                    confirmText="儲存紀錄"
                >
                    <p className="text-gray-600 dark:text-gray-300 mb-4">太棒了！你專注了 <span className="font-bold" style={{ color: 'var(--theme-600)' }}>{formatTime(seconds)}</span>。</p>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">這次學習了什麼內容？有什麼心得？</label>
                    <textarea 
                        ref={endNoteRef}
                        autoFocus
                        placeholder="例如：完成了第三章習題..."
                        rows={3}
                        className="w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none transition-all resize-none placeholder-gray-400 dark:placeholder-gray-500"
                        style={{ '--tw-ring-color': 'var(--theme-500)' }}
                        onFocus={(e) => { e.target.style.borderColor = 'var(--theme-500)'; e.target.style.boxShadow = '0 0 0 2px var(--theme-500)'; }}
                        onBlur={(e) => { e.target.style.borderColor = ''; e.target.style.boxShadow = 'none'; }}
                    />
                </Modal>

                {/* Color Picker Modal */}
                <Modal
                    title="選擇主題顏色"
                    isOpen={showColorModal}
                    onClose={() => setShowColorModal(false)}
                    onConfirm={() => setShowColorModal(false)}
                    confirmText="完成"
                >
                    <div className="space-y-4">
                        <div className="grid grid-cols-5 gap-3">
                            {PRESET_COLORS.map((c) => (
                                <button
                                    key={c}
                                    onClick={() => setThemeColor(c)}
                                    className={`w-full aspect-square rounded-full transition-transform hover:scale-110 border-2 ${themeColor === c ? 'border-gray-600 dark:border-gray-300 scale-110' : 'border-transparent'}`}
                                    style={{ backgroundColor: c }}
                                    title={c}
                                />
                            ))}
                        </div>
                        <div className="pt-4 border-t border-gray-100 dark:border-gray-700">
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">自訂調色盤</label>
                            <div className="flex items-center gap-3">
                                <input 
                                    type="color" 
                                    value={themeColor}
                                    onChange={(e) => setThemeColor(e.target.value)}
                                    className="h-10 w-20 p-1 rounded cursor-pointer border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700"
                                />
                                <span className="text-xs text-gray-500 dark:text-gray-400 font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">{themeColor}</span>
                            </div>
                        </div>
                    </div>
                </Modal>

                {/* Delete Confirmation Modal */}
                <Modal
                    title="刪除確認"
                    isOpen={showDeleteModal}
                    onClose={() => setShowDeleteModal(false)}
                    onConfirm={confirmDelete}
                    confirmText="確認刪除"
                    isDanger={true}
                >
                    <p className="text-gray-600 dark:text-gray-300">確定要刪除這筆讀書紀錄嗎？刪除後無法復原喔！</p>
                </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
